<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>轻量聊天室</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/static/css/animate.min.css">
    <link rel="stylesheet" href="/static/css/index.css?v=21">
    <!-- iOS Safari 兼容性修复 -->
    <link rel="stylesheet" href="/static/css/ios-compatibility.css?v=4"
        media="screen and (-webkit-min-device-pixel-ratio: 1)">
    <link rel="stylesheet" href="/static/css/ios-compatibility-index.css?v=1"
        media="screen and (-webkit-min-device-pixel-ratio: 1)">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 关键：在Vue加载前隐藏整个应用，防止模板闪现 -->
    <style>
        [v-cloak] {
            display: none !important;
        }
    </style>
</head>

<body>
    <div id="app" :class="{ 'dark-mode': isDarkMode }" v-cloak>

        <div class="layout-container" @click="hideEmojiPicker">
            <!-- 侧边栏 -->
            <aside class="sidebar" :class="{ 'sidebar-open': sidebarOpen }">
                <div class="sidebar-header">
                    <div class="app-brand">
                        <div class="brand-logo">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <span class="brand-name">轻量聊天室</span>
                    </div>
                    <button class="icon-btn mobile-only" @click="toggleSidebar">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- 用户信息卡片 -->
                <div class="user-info-card" v-if="currentUser.id">
                    <div class="user-details">
                        <div class="user-name" v-text="currentUser.nick_name"></div>
                        <div class="user-id">ID: <span v-text="currentUser.id"></span></div>
                        <div class="user-status">
                            <div class="status-dot"></div>
                            <span>在线</span>
                        </div>
                    </div>
                </div>

                <div class="sidebar-search">
                    <div class="search-input-wrapper">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="搜索...">
                    </div>
                    <button class="join-room-btn" @click="showJoinRoomDialog">
                        <i class="fas fa-door-open"></i>
                        加入房间
                    </button>
                </div>

                <div class="sidebar-nav">
                    <div class="nav-section-label">房间列表</div>
                    <div class="room-list">
                        <div v-if="roomList.length === 0" class="empty-rooms">
                            <div class="empty-icon">
                                <i class="fas fa-door-open"></i>
                            </div>
                            <div class="empty-text">还没有房间</div>
                            <div class="empty-subtitle">点击加入按钮开始聊天</div>
                        </div>
                        <div v-else v-for="(room, index) in roomList" :key="room.id" class="room-item"
                            :class="{ 'active': roomId == room.id }" @click="switchRoom(room)">
                            <div class="room-avatar-wrapper">
                                <div class="room-avatar" v-text="room.name.charAt(0)"></div>
                                <div class="room-status-indicator"></div>
                            </div>
                            <div class="room-details">
                                <div class="room-name" v-text="room.name"></div>
                                <div class="room-description" v-if="room.description" v-text="room.description"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="sidebar-footer">
                    <div class="footer-buttons">
                        <button class="footer-btn refresh-btn" :class="{ 'active': autoRefresh }"
                            @click="toggleAutoRefresh" :title="autoRefresh ? '关闭自动刷新' : '开启自动刷新'">
                            <i class="fas" :class="autoRefresh ? 'fa-play-circle' : 'fa-pause-circle'"></i>
                        </button>
                        <button class="footer-btn refresh-btn" @click="manualRefresh" title="手动刷新">
                            <i class="fas fa-redo"></i>
                        </button>
                        <button class="footer-btn theme-toggle" @click="toggleTheme" title="切换主题">
                            <i class="fas" :class="isDarkMode ? 'fa-sun' : 'fa-moon'"></i>
                        </button>
                    </div>
                    <div class="footer-info">
                        <span>安全连接</span>
                        <i class="fas fa-lock"></i>
                    </div>
                </div>
            </aside>

            <!-- 移动端遮罩 -->
            <div class="mobile-overlay" v-if="sidebarOpen" @click="toggleSidebar"></div>

            <!-- 主聊天区域 -->
            <main class="main-content">
                <!-- 顶部导航 -->
                <header class="chat-navbar">
                    <div class="nav-left">
                        <button class="menu-btn mobile-only" @click="toggleSidebar">
                            <i class="fas fa-bars"></i>
                        </button>
                        <div class="chat-info">
                            <h2 class="chat-title" v-text="roomName || '聊天中'"></h2>
                            <span class="chat-status">
                                <span class="dot"></span> <span v-text="onlineUsers"></span> 人在线
                            </span>
                        </div>
                    </div>
                    <div class="nav-right">
                        <button class="nav-icon-btn" @click="showComingSoon('语音通话')">
                            <i class="fas fa-phone"></i>
                        </button>
                        <button class="nav-icon-btn" @click="showComingSoon('视频通话')">
                            <i class="fas fa-video"></i>
                        </button>
                        <button class="nav-icon-btn" @click="showComingSoon('房间信息')">
                            <i class="fas fa-info-circle"></i>
                        </button>
                    </div>
                </header>

                <!-- 消息区域 -->
                <div class="messages-container" ref="messagesContainer">
                    <!-- 消息加载中 -->
                    <div v-if="messagesLoading" class="messages-loading">
                        <div class="loading-spinner-small">
                            <div class="spinner-small"></div>
                            <p>加载中...</p>
                        </div>
                    </div>

                    <div class="messages-list" v-else>
                        <div v-if="roomId === ''" class="empty-messages">
                            <div class="empty-icon">
                                <i class="fas fa-door-open"></i>
                            </div>
                            <div class="empty-text">还没有加入房间</div>
                            <div class="empty-subtitle">点击加入房间开始聊天</div>
                        </div>
                        <div v-else-if="messages.length === 0" class="empty-messages">
                            <div class="empty-icon">
                                <i class="fas fa-comments"></i>
                            </div>
                            <div class="empty-text">没有更多消息了</div>
                            <div class="empty-subtitle">开始新的对话吧</div>
                        </div>
                        <div v-for="(message, index) in messages" :key="message.id" class="msg-row"
                            :class="{ 'msg-own': message.isOwn }" :data-msg-id="message.id">

                            <div v-if="message.type === 'system'" class="msg-system">
                                <span class="system-badge" v-text="message.text"></span>
                            </div>

                            <div v-else class="msg-content-group"
                                @contextmenu.prevent="showContextMenu($event, message)">
                                <div v-if="!message.isOwn" class="msg-avatar" v-text="message.username.charAt(0)">
                                </div>

                                <div class="msg-bubble-wrapper">
                                    <div v-if="!message.isOwn" class="msg-sender">
                                        <span v-text="message.username"></span>
                                        <span class="msg-time" v-text="formatTime(message.time)"></span>
                                    </div>

                                    <div class="msg-bubble" :class="{ 'msg-image': message.type === 'image' }">
                                        <div v-if="message.type === 'image'" class="image-wrapper"
                                            @click="handleImageClick(message.imageUrl)">
                                            <img :src="message.imageUrl" loading="lazy" alt="Image">
                                        </div>
                                        <div v-else class="text-wrapper" v-text="message.text"></div>
                                    </div>

                                    <div v-if="message.isOwn" class="msg-time-own">
                                        <span v-text="formatTime(message.time)"></span>
                                        <!-- 发送状态图标 -->
                                        <span v-if="messageSendStatus && messageSendStatus[message.id]"
                                            class="msg-status-icon">
                                            <i v-if="messageSendStatus[message.id] === 'sending'"
                                                class="fas fa-spinner fa-spin" title="发送中"></i>
                                            <i v-else-if="messageSendStatus[message.id] === 'success'"
                                                class="fas fa-check-circle" title="发送成功"></i>
                                            <i v-else-if="messageSendStatus[message.id] === 'failed'"
                                                class="fas fa-exclamation-circle" title="发送失败，点击重试"></i>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 右键菜单 -->
                <transition name="menu-fade">
                    <div v-if="contextMenu.show" class="context-menu"
                        :style="{ top: contextMenu.y + 'px', left: contextMenu.x + 'px' }" @click.stop>
                        <div class="context-menu-item danger"
                            :class="{ 'disabled': !contextMenu.message || !contextMenu.message.isOwn }"
                            @click="burnMessage">
                            <i class="fas fa-fire"></i>
                            <span
                                v-text="contextMenu.message && contextMenu.message.isOwn ? '焚毁消息' : '只能焚毁自己的消息'"></span>
                        </div>
                    </div>
                </transition>

                <!-- 新消息提示 -->
                <transition name="slide-up">
                    <div v-if="showNewMessageTip" class="new-message-tip" @click="scrollToBottomAndHideTip">
                        <i class="fas fa-arrow-down"></i>
                        <span>有新消息</span>
                    </div>
                </transition>

                <!-- 输入区域 -->
                <div class="input-section">
                    <!-- 图片预览 -->
                    <div v-if="imagePreview && !isSending" class="upload-preview">
                        <div class="preview-card">
                            <img :src="imagePreview" alt="Preview">
                            <div class="file-info">
                                <span class="fname" v-text="selectedImageFile ? selectedImageFile.name : ''"></span>
                                <span class="fsize"
                                    v-text="selectedImageFile ? formatFileSize(selectedImageFile.size) : ''"></span>
                            </div>
                            <button class="remove-btn" @click="clearImagePreview">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <div class="input-bar">
                        <button class="attach-btn" @click="triggerImageUpload">
                            <i class="fas fa-plus-circle"></i>
                        </button>
                        <div class="text-input-wrapper">
                            <input v-model="newMessage" type="text" placeholder="说点什么..." @keyup.enter="sendMessage"
                                class="text-input">
                            <button class="emoji-btn" @click.stop="toggleEmojiPicker">
                                <i class="far fa-smile"></i>
                            </button>
                        </div>
                        <button class="send-btn" @click="sendMessage"
                            :disabled="(!newMessage.trim() && !selectedImageFile) || isSending"
                            :class="{ 'btn-loading': isSending }">
                            <i v-if="!isSending" class="fas fa-paper-plane"></i>
                            <i v-else class="fas fa-spinner fa-spin"></i>
                        </button>
                    </div>
                    <input type="file" ref="imageInput" @change="handleImageSelect" accept="image/*" hidden>

                <!-- 表情选择面板 -->
                <transition name="emoji-panel-slide">
                    <div v-if="showEmojiPicker" class="emoji-panel" ref="emojiPanel" @click.stop>
                        <div class="emoji-panel-header">
                            <div class="emoji-categories">
                                <button v-for="(category, index) in emojiCategories" :key="index"
                                    class="emoji-category-btn"
                                    :class="{ 'active': activeEmojiCategory === index }"
                                    @click="activeEmojiCategory = index">
                                    <span v-text="category.icon"></span>
                                </button>
                            </div>
                            <button class="emoji-panel-close" @click="hideEmojiPicker">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="emoji-content">
                            <div class="emoji-list" ref="emojiList">
                                <button v-for="emoji in emojiCategories[activeEmojiCategory].emojis"
                                    :key="emoji.char"
                                    class="emoji-item"
                                    @click="insertEmoji(emoji)"
                                    @touchend.prevent="insertEmoji(emoji)">
                                    <span v-text="emoji.char"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                </transition>
                </div>
            </main>
        </div>

        <!-- 图片查看器 -->
        <transition name="fade">
            <div v-if="isImageModalOpen" class="image-viewer" @click="handleModalClick">
                <button class="close-viewer" @click="closeImageModal">
                    <i class="fas fa-times"></i>
                </button>
                <div class="image-container" @touchstart="handleTouchStart" @touchmove="handleTouchMove"
                    @touchend="handleTouchEnd" @mousedown="handleMouseDown" @mousemove="handleMouseMove"
                    @mouseup="handleMouseUp" @mouseleave="handleMouseUp" @wheel="handleWheel"
                    :style="imageContainerStyle">
                    <img :src="currentImageUrl" :style="imageStyle" @click.stop @dragstart.prevent alt="Full View">
                </div>
            </div>
        </transition>

        <!-- 全局Loading -->
        <transition name="fade">
            <div v-if="globalLoading" class="global-loading">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <p class="loading-text" v-text="loadingText"></p>
                </div>
            </div>
        </transition>
    </div>

    <script src="/static/js/toast.js?v=2"></script>
    <script src="/static/js/ios-compatibility.js?v=2"></script>
    <script src="/static/js/vue.global.js"></script>
    <script>
        // iOS Safari 详细兼容性检查
        console.log('=== 页面开始加载 ===');
        console.log('User Agent:', navigator.userAgent);
        console.log('iOS版本检测:', /Version\/(\d+)/.exec(navigator.userAgent));
        console.log('Safari版本检测:', /Safari\/(\d+)/.exec(navigator.userAgent));

        // 检测支持的JavaScript特性
        console.log('ES6支持检测:');
        console.log('- 箭头函数:', (function () { try { eval('() => {}'); return true; } catch (e) { return false; } })());
        console.log('- 扩展运算符:', (function () { try { eval('const a = {...{}}'); return true; } catch (e) { return false; } })());
        console.log('- 可选链:', (function () { try { eval('const a = {}?.b'); return true; } catch (e) { return false; } })());
        console.log('- Map/Set:', typeof Map !== 'undefined' && typeof Set !== 'undefined');

        // 检查Vue加载状态
        function checkVueLoad() {
            if (typeof Vue !== 'undefined') {
                console.log('✅ Vue 已加载，版本:', Vue.version);
                console.log('Vue 对象:', Vue);
                console.log('createApp 方法:', typeof Vue.createApp);
            } else {
                console.log('❌ Vue 未加载');
            }
        }

        // 立即检查和延迟检查
        checkVueLoad();
        setTimeout(checkVueLoad, 100);

        // 错误捕获
        window.addEventListener('error', function (e) {
            console.error('=== JavaScript 错误 ===');
            console.error('文件:', e.filename);
            console.error('行号:', e.lineno);
            console.error('列号:', e.colno);
            console.error('错误:', e.error);
            console.error('消息:', e.message);
            alert('JS错误: ' + e.message + ' (第' + e.lineno + '行)');
        });

        window.addEventListener('unhandledrejection', function (e) {
            console.error('=== Promise 错误 ===');
            console.error('原因:', e.reason);
            alert('Promise错误: ' + e.reason);
        });
    </script>
    <script src="/static/js/index.js?v=22"></script>
</body>

</html>